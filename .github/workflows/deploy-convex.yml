name: Deploy Convex Backend

on:
  push:
    branches: [main]

jobs:
  check-affected:
    name: Check if backend deployment needed
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.affected }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Check if backend, teacher, or student affected
        id: check
        run: |
          # Check if backend, teacher, or student apps are affected
          pnpm turbo run build --filter='[HEAD^1]' --dry=json > affected.json

          # Safely check if apps are affected (handle grep exit codes)
          grep -q '"backend"\|"teacher"\|"student"' affected.json && AFFECTED=true || AFFECTED=false

          if [ "$AFFECTED" = "true" ]; then
            echo "affected=true" >> $GITHUB_OUTPUT
            echo "Backend deployment needed (backend, teacher, or student changed)"
          else
            echo "affected=false" >> $GITHUB_OUTPUT
            echo "No backend deployment needed"
          fi

  deploy:
    name: Deploy to Convex Production
    runs-on: ubuntu-latest
    needs: check-affected
    if: needs.check-affected.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy to Convex
        working-directory: apps/backend
        run: pnpm deploy --cmd 'pnpm run codegen'
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
